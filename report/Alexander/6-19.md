# 6‑20 Validation of C‑to‑Rust Translation  Report

- **Date:** 6‑19

## 1. Objective  
This is a demo experiment. We use KLEE to generate a set of full‑coverage test cases for a simple C program, execute both the original C program and the translated Rust program with these cases, and compare their outputs to verify the accuracy of the C→Rust translation.

## 2. Methodology

### 2.1 Test Case Generation  



- **Target C program:** `demo.c` 
 
 Generating 9 test cases for the following C program:
- **test cases**:  /results/klee_results/

```c
  #include <stdio.h>
#include <stdlib.h>

void suggest_activity(int day) {
    // Input validation
    if (day < 1) {
        printf("Invalid input: Day must be greater than 0\n");
        return;
    }
    else if (day > 7) {
        printf("Invalid input: Day must be less than 8\n");
        return;
    }

    // Activity mapping
    switch (day) {
        case 1: printf("Monday: Work\n"); break;
        case 2: printf("Tuesday: Study\n"); break;
        case 3: printf("Wednesday: Exercise\n"); break;
        case 4: printf("Thursday: Watch movie\n"); break;
        case 5: printf("Friday: Party\n"); break;
        case 6: printf("Saturday: Outing\n"); break;
        case 7: printf("Sunday: Rest\n"); break;
    }
}

int main(int argc, char **argv) {
    int input_day;

    if (argc > 1) {
        input_day = atoi(argv[1]);
    } else {
        printf("Enter day (1-7): \n");
        if (scanf("%d", &input_day) != 1) {
            printf("Error: Invalid input\n");
            return 1;
        }
    }
    suggest_activity(input_day);
    return 0;
}
```

### 2.2 C to Rust Translation
- **Tool:** c2rustify  
- **Input:** `demo.c`  
- **Output:** `demo.rs`  
```rust
pub fn suggest_activity(day: i32) {
    match day {
        1 => println!("Monday: Work"),
        2 => println!("Tuesday: Study"),
        3 => println!("Wednesday: Exercise"),
        4 => println!("Thursday: Watch movie"),
        5 => println!("Friday: Party"),
        6 => println!("Saturday: Outing"),
        7 => println!("Sunday: Rest"),
        _ => {
            if day < 1 {
                println!("Invalid input: Day must be greater than 0");
            } else {
                println!("Invalid input: Day must be less than 8");
            }
        }
    }
}
pub fn main() {
    let input_day: i32;

    let args: std::vec::Vec<std::string::String> = std::env::args().collect();

    if args.len() > 1 {
        input_day = args[1].parse().unwrap_or_else(|_| {
            eprintln!("Error: Invalid input");
            std::process::exit(1);
        });
    } else {
        println!("Enter day (1-7): ");
        let mut input = std::string::String::new();
        std::io::stdin().read_line(&mut input).expect("Failed to read line");

        input_day = input.trim().parse().unwrap_or_else(|_| {
            eprintln!("Error: Invalid input");
            std::process::exit(1);
        });
    }

    suggest_activity(input_day);
}
```
### 2.3 Single‑Case Execution and Comparison
- **Method:** Run one generated test case on both `demo.c` and `demo.rs`
- **Outputs**:
  - `c_result`
  - `rust_result`
- **Comparison**: Check whether the two results match

### 2.4 Batch Test-Case Comparison
- **Batch script**: 

```bash
#!/bin/bash
# Configuration paths
KTEST_DIR="../klee_results"
C_PROGRAM="../helloworld.c"
RUST_PROGRAM="../helloworld.rs"
C_OUTPUT="c_result.txt"
RUST_OUTPUT="rust_result.txt"
C_EXECUTABLE="c_demo"
RUST_EXECUTABLE="rust_demo"

echo "=== KLEE Test Comparison Script ==="
KTEST_FILES=("$KTEST_DIR"/test*.ktest)

# Compile C program
echo "Compiling C program..."
if ! gcc -o "$C_EXECUTABLE" "$C_PROGRAM"; then
    echo "Error: Failed to compile C program"
    exit 1
fi
echo "C program compiled successfully"

# Compile Rust program
echo "Compiling Rust program..."
if ! rustc -o "$RUST_EXECUTABLE" "$RUST_PROGRAM"; then
    echo "Error: Failed to compile Rust program"
    exit 1
fi
echo "✅ Rust program compiled successfully"

echo "DEBUG: Programs compiled, processing all test cases..."

# Initialize counters
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# Process each .ktest file
for KTEST_FILE in "${KTEST_FILES[@]}"; do
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    TEST_NAME=$(basename "$KTEST_FILE" .ktest)
    
    echo ""
    echo "=== Processing $TEST_NAME ==="
    
    # Debug: Show what ktest-tool outputs
    echo "DEBUG: Raw ktest-tool output:"
    ktest-tool "$KTEST_FILE"
    echo "DEBUG: End of ktest-tool output"
    
    # Extract input parameter from "object 0: int :" line
    INPUT=$(ktest-tool "$KTEST_FILE" 2>/dev/null | grep "object 0: int :" | sed 's/.*: //')
    echo "Successfully extracted input: $INPUT"
    
    # Run programs with extracted input
    echo "Running C program..."
    if ! echo "$INPUT" | ./"$C_EXECUTABLE" > "$C_OUTPUT"; then
        echo "Error: Failed to run C program for $TEST_NAME"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        continue
    fi
    
    echo "Running Rust program..."
    if ! echo "$INPUT" | ./"$RUST_EXECUTABLE" > "$RUST_OUTPUT"; then
        echo "Error: Failed to run Rust program for $TEST_NAME"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        continue
    fi
    
    # Display results for this test
    echo "Input: $INPUT"
    echo "C   output: $(cat $C_OUTPUT)"
    echo "Rust output: $(cat $RUST_OUTPUT)"
    
    # Compare results
    if diff -q "$C_OUTPUT" "$RUST_OUTPUT" >/dev/null; then
        echo "$TEST_NAME: Results match"
        PASSED_TESTS=$((PASSED_TESTS + 1))
    else
        echo "$TEST_NAME: Results differ"
        echo "Detailed differences:"
        diff "$C_OUTPUT" "$RUST_OUTPUT"
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi
done

# Clean up temporary files
rm -f "$C_OUTPUT" "$RUST_OUTPUT"

# Final summary
echo ""
echo "=== FINAL SUMMARY ==="
echo "Total tests: $TOTAL_TESTS"
echo "Passed: $PASSED_TESTS"
echo "Failed: $FAILED_TESTS"

if [ $FAILED_TESTS -eq 0 ]; then
    echo ""
    echo "All tests passed - Translation fully verified!"
    rm -f "$C_EXECUTABLE" "$RUST_EXECUTABLE"
    exit 0
else
    echo ""
    echo "Some tests failed - Translation issues detected!"
    # Keep executables for debugging
    exit 1
fi
```

- **Test set**: 9 cases
- **Comparison logic**: Verify whether all 9 cases produce identical results

## 3. Results

### 3.1 KLEE Test-Case Generation Statistics

- **Total cases generated**: 9
- **Valid cases**: 7

### 3.2 Single-Case Comparison Example

| Test Case Input | C Result (c_result) | Rust Result (rust_result) | Match? |
|-----------------|---------------------|---------------------------|--------|
| 2              | Study              | Study                    | yes    |

### 3.3 Batch Test Results Summary

- **Total test cases**: 9
- **Matching cases / percentage**: 9 / 100%
- **Non-matching cases / percentage**: 0 / 0%

## 4. Conclusion

- KLEE can generate full-coverage test cases for C programs.
- By scripting the automatic execution of both C and Rust binaries and comparing their outputs, we can verify the accuracy of C to Rust translations.

## 5. Next Steps

Use c2rustify to translate the nine C programs in the cat suite into Rust. Then, use KLEE to auto‑generate test cases for those C programs, run both C and Rust versions with a batch script, and compare outputs to validate translation accuracy.